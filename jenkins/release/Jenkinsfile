pipeline {
    agent any
    
    parameters {
        string(name: 'COMMIT_SHA', description: 'Git commit SHA to tag')
        string(name: 'BASE_VERSION', description: 'Base app version (branch name)')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git checkout ${COMMIT_SHA}'
            }
        }
        
        stage('Build Artifact') {
            steps {
                sh 'chmod +x ./gradlew'
                sh './gradlew clean build'
            }
        }
        
        stage('Create Release Tag') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh '''
                            git config user.name "${GIT_USER}"
                            
                            # Get app version from gradle.properties or build.gradle
                            if [ -f gradle.properties ]; then
                                APP_VERSION=$(grep "version" gradle.properties | head -1 | awk -F'=' '{print $2}' | tr -d ' ')
                            else
                                APP_VERSION=$(grep "version" gradle.properties | head -1 | awk -F'=' '{print $2}' | tr -d ' ')
                            if [ -z "$APP_VERSION" ]; then
                                APP_VERSION=$(grep "version" build.gradle | grep -v "//" | head -1 | awk -F"['\"]" '{print $2}' | tr -d ' ')
                            fi
                            fi
                            
                            echo "APP_VERSION: $APP_VERSION"
                            
                            # Create tag: base_version-app_version
                            TAG_NAME="${BASE_VERSION}-v${APP_VERSION}"
                            
                            echo "Creating tag: $TAG_NAME"
                            
                            git tag -a ${TAG_NAME} -m "Release ${TAG_NAME}"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/InSearchOfName/book-writer.git ${TAG_NAME}
                        '''
                    }
                }
            }
        }
        
        stage('Create GitHub Release with Artifacts') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh '''
                            APP_VERSION=$(grep "version" build.gradle | grep -v "//" | head -1 | awk -F"['\"]" '{print $2}' | tr -d ' ')
                            TAG_NAME="${BASE_VERSION}-v${APP_VERSION}"
                            ARTIFACT=$(find build/libs -name "*.jar" -type f | head -1)
                            ARTIFACT_NAME=$(basename ${ARTIFACT})
                            
                            echo "Creating release: $TAG_NAME"
                            echo "Uploading artifact: $ARTIFACT_NAME"
                            
                            # Create GitHub release
                            RELEASE_RESPONSE=$(curl -s -X POST \
                              -H "Accept: application/vnd.github.v3+json" \
                              -H "Authorization: token ${GIT_PASS}" \
                              https://api.github.com/repos/InSearchOfName/book-writer/releases \
                              -d "{\"tag_name\":\"${TAG_NAME}\",\"name\":\"Release ${TAG_NAME}\",\"body\":\"Automated release for ${TAG_NAME}\"}")
                            
                            # Extract upload URL from response
                            UPLOAD_URL=$(echo ${RELEASE_RESPONSE} | grep -o '"upload_url": "[^"]*' | cut -d'"' -f4 | sed 's/{.*}//')
                            
                            # Upload artifact to release
                            curl -X POST \
                              -H "Authorization: token ${GIT_PASS}" \
                              -H "Content-Type: application/octet-stream" \
                              --data-binary @${ARTIFACT} \
                              "${UPLOAD_URL}?name=${ARTIFACT_NAME}"
                            
                            echo "Release created and artifact uploaded successfully"
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
    }
}
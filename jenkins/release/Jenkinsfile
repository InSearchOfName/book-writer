pipeline {
    agent any
    
    parameters {
        string(name: 'COMMIT_SHA', description: 'Git commit SHA to tag')
        string(name: 'BASE_VERSION', description = 'Base app version (branch name)')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git checkout ${COMMIT_SHA}'
            }
        }
        
        stage('Build Artifact') {
            steps {
                sh 'chmod +x ./gradlew'
                sh './gradlew clean build'
            }
        }
        
        stage('Create Release Tag') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh '''
                            git config user.name "${GIT_USER}"
                            
                            # Get app version from build.gradle
                            APP_VERSION=$(grep "version = " build.gradle | head -1 | sed "s/.*version = ['\\'\"]//" | sed "s/['\\'\"].*//" | tr -d ' ')
                            
                            echo "APP_VERSION: $APP_VERSION"
                            
                            # Create tag: base_version-app_version
                            TAG_NAME="${BASE_VERSION}-v${APP_VERSION}"
                            
                            git tag -a ${TAG_NAME} -m "Release ${TAG_NAME}"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/InSearchOfName/book-writer.git ${TAG_NAME}
                        '''
                    }
                }
            }
        }
    }
    
    post {
        cleanup {
            cleanWs()
        }
    }
}
pipeline {
    agent any

    parameters {
        string(name: 'COMMIT_SHA', description: 'Git commit SHA to tag')
        string(name: 'BASE_VERSION', description: 'Base app version (branch name)')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh "git checkout ${COMMIT_SHA}"
            }
        }

        stage('Build Artifact') {
            steps {
                sh 'chmod +x ./gradlew'
                sh './gradlew clean build'
            }
        }

        stage('Create Release Tag') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'github',
                            usernameVariable: 'GIT_USER',
                            passwordVariable: 'GIT_PASS'
                        )
                    ]) {
                        sh '''
                            set -e

                            git config user.name "${GIT_USER}"

                            if [ ! -f gradle.properties ]; then
                              echo "gradle.properties not found"
                              exit 1
                            fi

                            APP_VERSION=$(grep '^mod_version=' gradle.properties | cut -d= -f2 | tr -d ' ')

                            if [ -z "$APP_VERSION" ]; then
                              echo "mod_version not found in gradle.properties"
                              exit 1
                            fi

                            echo "APP_VERSION: $APP_VERSION"

                            TAG_NAME="${BASE_VERSION}-v${APP_VERSION}"
                            echo "Creating tag: $TAG_NAME"

                            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/InSearchOfName/book-writer.git "$TAG_NAME"
                        '''
                    }
                }
            }
        }

        stage('Create GitHub Release with Artifacts') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'github',
                            usernameVariable: 'GIT_USER',
                            passwordVariable: 'GIT_PASS'
                        )
                    ]) {
                        sh '''
                            set -e

                            APP_VERSION=$(grep '^mod_version=' gradle.properties | cut -d= -f2 | tr -d ' ')
                            TAG_NAME="${BASE_VERSION}-v${APP_VERSION}"

                            ARTIFACT=$(find build/libs -name "*.jar" -type f | head -1)

                            if [ -z "$ARTIFACT" ]; then
                              echo "No artifact found"
                              exit 1
                            fi

                            ARTIFACT_NAME=$(basename "$ARTIFACT")

                            echo "Creating GitHub release: $TAG_NAME"
                            echo "Uploading artifact: $ARTIFACT_NAME"

                            RELEASE_RESPONSE=$(curl -s -X POST \
                              -H "Accept: application/vnd.github.v3+json" \
                              -H "Authorization: token ${GIT_PASS}" \
                              https://api.github.com/repos/InSearchOfName/book-writer/releases \
                              -d "{\"tag_name\":\"${TAG_NAME}\",\"name\":\"Release ${TAG_NAME}\",\"body\":\"Automated release for ${TAG_NAME}\"}")

                            UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | sed -n 's/.*"upload_url":[ ]*"\\([^"]*\\)".*/\\1/p' | sed 's/{.*}//')

                            if [ -z "$UPLOAD_URL" ]; then
                              echo "Failed to get upload_url"
                              echo "$RELEASE_RESPONSE"
                              exit 1
                            fi

                            curl -X POST \
                              -H "Authorization: token ${GIT_PASS}" \
                              -H "Content-Type: application/octet-stream" \
                              --data-binary @"$ARTIFACT" \
                              "${UPLOAD_URL}?name=${ARTIFACT_NAME}"

                            echo "Release created successfully"
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
